version: 2

defaults: &defaults
  working_directory: /tmp
  docker:
    - image: buildpack-deps:trusty

jobs:
  conda-linux:
    <<: *defaults
    steps:
      - run: mkdir -p workspace
      - run: wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh
      - run: bash miniconda.sh -b -p workspace/miniconda
      - persist_to_workspace:
          root: workspace
          paths:
            - miniconda
  create-env-27:
    <<: *defaults
    steps:
      - attach_workspace:
          at: /tmp/workspace
      - run: echo 'export PATH=/tmp/workspace/miniconda/bin:$PATH' >> $BASH_ENV
      - run: conda config --set always_yes yes --set changeps1 no
      - run: conda update -q conda
      - run: conda create -q --prefix workspace/test-environment python=2.7 pip
      - persist_to_workspace:
          root: workspace
          paths:
            - test-environment
  test:
    <<: *defaults
    environment:
      TEST_NWB_FILES: skip
      TEST_OBSERVATORY_EXPERIMENT_PLOTS_DATA: skip
      TEST_API_ENDPOINT: http://api.brain-map.org 
      TEST_COMPLETE: false
    steps:
      - attach_workspace:
          at: /tmp/workspace
      - run: echo 'export PATH=/tmp/workspace/miniconda/bin:$PATH' >> $BASH_ENV
      - run: source activate workspace/test-environment
      - checkout eyetracking
      - run: cd eyetracking
      - run: pip install -r test_requirements.txt
      - run: pip install .
      - run: make test

workflows:
  version: 2
  linux-27:
    jobs:
      - conda-linux
      - create-env-27:
          requires:
            - conda-linux
      - test:
          requires:
            - create-env-27
